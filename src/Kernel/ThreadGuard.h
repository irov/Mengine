#pragma once

#include "Config/Atomic.h"
#include "Config/Char.h"

#include <thread>

//////////////////////////////////////////////////////////////////////////
#if !defined(MENGINE_THREAD_GUARD)
#   if defined(MENGINE_DEBUG)
#       define MENGINE_THREAD_GUARD 1
#   else
#       define MENGINE_THREAD_GUARD 0
#   endif
#endif
//////////////////////////////////////////////////////////////////////////
#if MENGINE_THREAD_GUARD == 1
#   define MENGINE_THREAD_GUARD_ENABLE
#endif
//////////////////////////////////////////////////////////////////////////
namespace Mengine
{
    class ThreadGuard
    {
    public:
        ThreadGuard();
        ~ThreadGuard();

    public:
        std::thread::id getLockThreadId() const;

    public:
        void check( const Char * _doc ) const;
        bool lock( bool _value ) const;

    protected:
        std::thread::id m_initThreadId;
        mutable std::thread::id m_lockThreadId;
        mutable AtomicBool m_lock;
    };
}
//////////////////////////////////////////////////////////////////////////
#if defined(MENGINE_THREAD_GUARD_ENABLE)
    //////////////////////////////////////////////////////////////////////////
#   define MENGINE_THREAD_GUARD_INIT(Type)\
    public:\
    Mengine::ThreadGuard __mengine_thread_guard##Type\
    //////////////////////////////////////////////////////////////////////////
#   define MENGINE_THREAD_GUARD_CHECK(Type, Self, Doc)\
    Self->__mengine_thread_guard##Type.check( Doc )
    //////////////////////////////////////////////////////////////////////////
#   define MENGINE_THREAD_GUARD_RESET(Type, Self)\
    Self->__mengine_thread_guard##Type.reset()
    //////////////////////////////////////////////////////////////////////////
#else
    //////////////////////////////////////////////////////////////////////////
#   define MENGINE_THREAD_GUARD_INIT(Type)
    //////////////////////////////////////////////////////////////////////////
#   define MENGINE_THREAD_GUARD_CHECK(Type, Self, Doc)
    //////////////////////////////////////////////////////////////////////////
#   define MENGINE_THREAD_GUARD_RESET(Type, Self)
    //////////////////////////////////////////////////////////////////////////
#endif