#	include "SoundSystemInterface.h"
#	include "Manager/XmlManager.h"
#	include "SoundNode.h"
#	include "SoundEngine.h"
#	include "ObjectImplement.h"

//////////////////////////////////////////////////////////////////////////
OBJECT_IMPLEMENT(SoundNode);
//////////////////////////////////////////////////////////////////////////
void intrusive_ptr_add_ref(Menge::SoundNode *_n)
{
	_n->addRefCnt();
}
//////////////////////////////////////////////////////////////////////////
void intrusive_ptr_release(Menge::SoundNode *_n)
{
	_n->releaseRefCnt();
}
//////////////////////////////////////////////////////////////////////////
SoundNode::SoundNode(SoundSystemInterface * _soundSystem, SoundSourceInterface * _interface)
	: m_ssytem(_soundSystem)
	, m_interface(_interface)
	, m_refCnt(0)
{}
//////////////////////////////////////////////////////////////////////////
SoundNode::~SoundNode()
{
	m_ssytem->releaseSoundNode(m_interface);
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::play()
{
	m_interface->play();
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::pause()
{
	m_interface->pause();
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::stop()
{
	m_interface->stop();
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::setLooped(bool _flag)
{
	m_interface->setLooped(_flag);
}
//////////////////////////////////////////////////////////////////////////
bool		SoundNode::getLooped() const
{
	return	m_interface->getLooped();
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::setVolume(float _value)
{
	m_interface->setVolume(_value);
}
//////////////////////////////////////////////////////////////////////////
float		SoundNode::getVolume() const
{
	return	m_interface->getVolume();
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::setPosition(const float* _position)
{
	m_interface->setPosition(_position);
}
//////////////////////////////////////////////////////////////////////////
const float*	SoundNode::getPosition() const
{
	return m_interface->getPosition();
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::setDistance(float dist)
{
	m_interface->setDistance(dist);
}
//////////////////////////////////////////////////////////////////////////
float		SoundNode::getDistance() const
{
	return m_interface->getDistance();
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::setHeadMode(bool flag)
{
	m_interface->setHeadMode(flag);
}
//////////////////////////////////////////////////////////////////////////
bool		SoundNode::updateSoundBuffer()
{
	return m_interface->updateSoundBuffer();
}
//////////////////////////////////////////////////////////////////////////
bool		SoundNode::getHeadMode() const
{
	return	m_interface->getHeadMode();
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::addRefCnt()
{
	++m_refCnt;
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::releaseRefCnt()
{
	if(m_refCnt == 1)
	{
		delete this;
	}
	else
	{
		--m_refCnt;
	}
}
//////////////////////////////////////////////////////////////////////////
size_t		SoundNode::refCnt()
{
	return m_refCnt;
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::_update(float _timing)
{
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::loader(TiXmlElement * xml)
{
	XML_FOR_EACH_TREE(xml)
	{
		XML_CHECK_NODE("SoundNode")
		{
			XML_VALUE_ATTRIBUTE("File", m_filename);
		}		
	}
}
//////////////////////////////////////////////////////////////////////////
bool		SoundNode::_compile()
{
	Keeper<SoundEngine>::hostage()->addSoundNode(this,m_filename);
	return	true;
}
//////////////////////////////////////////////////////////////////////////
void		SoundNode::_release()
{
	Keeper<SoundEngine>::hostage()->deleteSoundNode(m_filename);
}